<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/jquery-migrate-3.0.0.js"></script>
    
    <script src="js/bootstrap.min.js"></script>
    <script src="js/video.min.js"></script>
    <script src="js/videojs-offset.js"></script>

    <title>Interaction Annotation Test</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/video-js.min.css">
    <link rel="stylesheet" href="css/custom.css">
  </head>

  <body onLoad="init()">
  <div class="container">
    <div class="row"></div>
  </div>

  <div class="container" style="margin-top: 20px;">
    <div class="starter-template">
      <div class="progress">
        <div class="progress-bar" role="progressbar" aria-valuenow="0"
        aria-valuemin="0" aria-valuemax="100" style="width:0%">
        <span>0%</span>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="starter-template">
      <h1>Video Adjustment</h1>
      <p class="lead">Adjust video's duration until a video contains a whole interaction. <br>
        You can use '-' and '+' buttons on the left and right side of a video </p>
    </div>
  </div>

  <div class="container">
    <div class="row"></div>
  </div>

  <div class="container">
    <div class="row vertical-align">
      <div class="col-md-3" style="text-align: right;">
        <button type="button" class="btn btn-primary btn-lg toggle-off" style="margin: 5px;" id="left_minus">&#8592;</button>
        <button type="button" class="btn btn-primary btn-lg toggle-off" style="margin: 5px;" id="left_plus">&#8594;</button>
      </div>
      <div class="col-md-6">
        <video class="video-js vjs-big-play-centered" autoplay muted controls preload="auto" loop data-setup='{"fluid": true, "playbackRates": [0.5, 1, 1.5, 2, 3, 4] }' id="refer_video1">
          <p class="vjs-no-js">
            To view this video please enable JavaScript, and consider upgrading to a web browser that
            <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
          </p>
        </video>
      </div>
      <div class="col-md-3" style="text-align: left;">
        <button type="button" class="btn btn-primary btn-lg toggle-off" style="margin: 5px;" id="right_minus">&#8592;</button>
        <button type="button" class="btn btn-primary btn-lg toggle-off" style="margin: 5px;" id="right_plus">&#8594;</button>
      </div>
    </div>
  </div>

 
  <div class="container" style="margin-top: 30px;">
    <div="row">
      <div class="col-md-6" style="text-align: left">
        <button type="button" class="btn btn-primary" onclick="window.open('instr.html');">Read Instruction</button>
      </div>
      <div class="col-md-6" style="text-align: right">
        <button type="button" class="btn btn-success" id="next_btn">Next</button>
        <button type="button" class="btn btn-success" id="submit_btn" style="display: none">Submit</button>
      </div>
    </div>
  </div>

  <div class="container">
    <form name='mturk_form' method='post' id='mturk_form'>
      <input type='hidden' value='' name='numTest' id='numTest' />
      <input type='hidden' value='' name='taskId' id='taskId' />
      <input type='hidden' value='' name='assignmentId' id='assignmentId'/>
      <input type='hidden' value='' name='workerId' id='workerId'/>
    </form>
  </div>
    
  </body>
    <script>
      var required_pts = 10;
      var num_pts = 0;
      var num_test = 0;
      var test_num = 1;

      var max_width = 560;
      var max_height = 400;

      var points_x = [0,0,0,0,0,0,0,0,0,0];
      var points_y = [0,0,0,0,0,0,0,0,0,0];
      
      var video_list = [];
      var duration_list = [];
      var start_list = [];
      var end_list = [];

      var start_time = 0;
      var end_time = 0;

      var player1 = videojs("#refer_video1");
      var video_duration = 0;

      var is_none = false;

      $("#left_minus").on('click', minusLeft);
      $("#left_plus").on('click', plusLeft);
      $("#right_minus").on('click', minusRight);
      $("#right_plus").on('click', plusRight);

      $("#next_btn").on('click', getAnswer);
      $("#submit_btn").on('click', submitAnswer);

      function init() {
        task_id = 1;
        aid = 123;
        wid = 234; 
        turkSubmit = 432;
        console.log("task_id: " + task_id);
        console.log("num_test: " + num_test);

        
        document.getElementById('taskId').value = task_id;
        document.getElementById('assignmentId').value = aid;
        document.getElementById('workerId').value = wid;
        document.getElementById('mturk_form').action = turkSubmit + "/mturk/externalSubmit";

        task_file_url = "tasklist/task" + task_id + ".txt";
        jQuery.get(task_file_url, function(data) {
          var lines = data.split("\n");
          num_test = lines[0];
          console.log("num_test: " + num_test);
          document.getElementById('numTest').value = num_test;
          for (var i=1, len=lines.length; i<len; i++){
            var video_time = lines[i].split(" ");
            video_list.push(video_time[0]);
            duration_list.push(video_time[1]);
            start_list.push(video_time[2]);
            end_list.push(video_time[3]);

            if(i == num_test) {
              player1.src({type: 'video/mp4', src: "resource/"+video_list[0]});
              video_duration = duration_list[0];
              start_time = start_list[0];
              end_time = end_list[0];
              player1.offset({start: start_time, end:end_time});
              updateProgressbar();      
            }
          }
        });
      }

      function minusLeft() {
        start_time = parseInt(start_time) - 1;
        start_time = start_time.toString();
        player1.offset({start: start_time, end:end_time});

        checkRangeAvailable();
      }

      function plusLeft() {
        start_time = parseInt(start_time) + 1;
        start_time = start_time.toString();
        player1.offset({start: start_time, end:end_time});

        checkRangeAvailable();
      }

      function minusRight() {
        end_time = parseInt(end_time) - 1;
        end_time = end_time.toString();
        player1.offset({start: start_time, end:end_time});

        checkRangeAvailable();
      }

      function plusRight() {
        end_time = parseInt(end_time) + 1;
        end_time = end_time.toString();
        player1.offset({start: start_time, end:end_time});

        checkRangeAvailable();
      }

      function checkRangeAvailable() {
        if (parseInt(start_time) == 0) {
          $("#left_minus").prop("disabled", true);
        }

        if (parseInt(end_time) == parseInt(video_duration)) {
          $("#right_plus").prop("disabled", true);
        }

        if (parseInt(start_time) == parseInt(end_time) - 1) {
          $("#left_plus").prop("disabled", true);
          $("#right_minus").prop("disabled", true);
        }

        if (parseInt(start_time) < parseInt(end_time) -1) {
          $("#left_plus").prop("disabled", false);
          $("#right_minus").prop("disabled", false);
        }
      }

      function getAnswer() {
        console.log("getAnswer");


        var answer = video_list[test_num-1] + ":::::" + start_time + ":::" + end_time;

        var input_form = '<input type="hidden" class="ans" id="ans' + test_num + '" name="ans' + test_num + '" value="' + answer + '"></input>';
        $('#mturk_form').append(input_form);

        console.log(answer);

        getNextData();
      }

      function getNextData() {
        player1.src({type: 'video/mp4', src: "resource/"+video_list[test_num]});
        video_duration = duration_list[test_num];
        start_time = start_list[test_num];
        end_time = end_list[test_num];
        player1.offset({start: start_time, end:end_time});
        checkRangeAvailable();

        test_num = test_num + 1;
        updateProgressbar();

        if(test_num == num_test) {
          $("#next_btn").css("display", "none");
          $("#submit_btn").css("display", "inline-block");
        }
        console.log("next data");
      }

      function submitAnswer() {
        getAnswer();
        console.log($("#numTest").val());
        $.get('test.php?'+$('#mturk_form').serialize(), function(data) {
          $('#mturk_form').submit();
        });
      }

      function updateProgressbar() {
        percent = Math.ceil(test_num / num_test * 100);
        percent_str = percent + "%";

        $(".progress-bar").attr("aria-valuenow", percent);
        $(".progress-bar").css("width", percent_str);
        $(".progress-bar span").text(percent_str);
      }
    </script>

</html>
